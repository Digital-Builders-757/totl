````markdown
# TOTL Agency â€“ Cursor AI Assistant Rules

## ðŸŽ¯ MANDATORY CONTEXT REFERENCE

**BEFORE WRITING ANY CODE, YOU MUST:**

1. **READ** `AGENT_ONBOARDING.md` (NEW AGENTS START HERE)
2. **READ** `TOTL_PROJECT_CONTEXT_PROMPT.md` completely
3. **CHECK** `supabase/migrations/` for current database schema
4. **VERIFY** RLS policies in the context file
5. **USE** generated types from `types/database.ts` / `@/types/supabase` (NO `any` types)
6. **FOLLOW** established project structure and naming conventions

If any of these files are missing from the context, request them explicitly before proceeding.

---

## ðŸš¨ RED ZONE FILES (NO BLIND REWRITES)

These files control **auth, routing, and schema truth**. They must **never** be auto-rewritten or heavily refactored in a single pass.

**Red Zone â€“ Auth & Routing**

- `components/auth/auth-provider.tsx`
- `middleware.ts`
- `app/talent/dashboard/page.tsx`
- `app/talent/dashboard/client.tsx`
- `app/client/dashboard/page.tsx`
- `app/client/dashboard/client.tsx`
- `app/(auth)/**` (login, signup, verification, choose-role, reset-password flows)
- `app/api/auth/*`
- `docs/SIGN_OUT_IMPROVEMENTS.md`
- `docs/AUTH_STRATEGY.md`
- `docs/TALENT_DASHBOARD_FLOW.md` (if present)

**Red Zone â€“ Schema & Types**

- `database_schema_audit.md`
- `supabase/migrations/**`
- `types/database.ts`
- `types/supabase.ts` (or equivalent re-export)
- `docs/DATABASE_REPORT.md`

**Red Zone â€“ Project Context**

- `TOTL_PROJECT_CONTEXT_PROMPT.md`
- `.cursorrules`

### Red Zone Editing Protocol (MANDATORY)

When modifying ANY Red Zone file:

1. **Show current file contents** (or at least the relevant section).
2. **Summarize the existing behavior** in plain language.
3. **Propose a small, explicit change** (minimal diff) â€“ not a full rewrite.
4. **Apply only that change**, preserving existing working logic.
5. **Re-read** `docs/AUTH_STRATEGY.md`, `docs/SIGN_OUT_IMPROVEMENTS.md`, and `database_schema_audit.md` if the change touches:
   - auth state
   - middleware behavior
   - dashboards
   - database schema
6. **Never**:
   - Convert a Red Zone file into a â€œbrand new patternâ€ all at once.
   - Remove working logic without explaining why.
   - Introduce `window.location.reload()` into auth/dashboards.

If a large refactor is truly needed, it must be broken into **small, reversible steps** with clear justification for each.

---

## ðŸ“‹ PROJECT OVERVIEW

**TOTL Agency** â€“ Talent booking platform connecting models/actors with casting directors and brands.

**Tech Stack:**

- Next.js 15.2.4 + App Router + TypeScript 5
- Supabase (PostgreSQL + Auth + Storage + Real-time)
- TailwindCSS + shadcn/ui components
- Resend API for custom emails

**Database:** PostgreSQL with RLS on all tables  
**Auth:** Supabase Auth with role-based access (talent/client/admin)  
**Key Tables:** `profiles`, `talent_profiles`, `client_profiles`, `gigs`, `applications`, `bookings`, `portfolio_items`

---

## ðŸ“‹ PROJECT CONTEXT SUMMARY

- **Tech:** Next.js App Router + Supabase + TypeScript + shadcn/ui
- **Database:** PostgreSQL with strict RLS
- **Auth:** Role-based (`talent`, `client`, `admin`) tied to `profiles`
- **Security:** RLS enforced everywhere, no service keys in client
- **Architecture:** Server components for data fetching; presentational components only on the client

---

## âœ… COMPLIANCE CHECKLIST (BEFORE GENERATING CODE)

Before writing or editing any code, confirm:

- [ ] Read `TOTL_PROJECT_CONTEXT_PROMPT.md` for full context
- [ ] **database_schema_audit.md is treated as SINGLE SOURCE OF TRUTH**
- [ ] Used proper TypeScript types (no `any`)
- [ ] Followed RLS-compatible query patterns
- [ ] Kept database logic **out of React components**
- [ ] Used centralized Supabase clients (`lib/supabase-client.ts` / `lib/supabase-admin-client.ts`)
- [ ] Implemented meaningful error handling
- [ ] Followed project naming and folder conventions
- [ ] For Red Zone files, followed the **Red Zone Editing Protocol**

---

## ðŸ—ï¸ ARCHITECTURE RULES

### Database Access

- Use `lib/supabase-client.ts` for **client-side** queries (user-level access).
- Use `lib/supabase-admin-client.ts` for **server-side admin** operations only.
- Always assume **RLS is active** â€“ do not attempt to bypass it.
- Use generated types from `@/types/supabase` / `types/database.ts`.

### Component Structure

- React components should be **presentational**.
- **No direct database calls** in components.
- Use **server components** and server actions for data fetching/mutations.
- Pass data into client components via **props** or typed hooks localized to the feature.

---

## ðŸ” AUTHENTICATION & AUTHORIZATION

- **BEFORE ANY AUTH CHANGES:** Read `docs/AUTH_DATABASE_TRIGGER_CHECKLIST.md` and `docs/AUTH_STRATEGY.md`.
- Use `@supabase/auth-helpers-nextjs` patterns for session management.
- Check user roles before privileged actions.
- Use `middleware.ts` for route protection.
- Implement strong error handling for auth failures.
- Verify database triggers and constraints match `database_schema_audit.md`.

### Auth Ownership & Dashboards (CRITICAL)

- `AuthProvider` is the **single source of truth** for:
  - `session`
  - `user`
  - `profile`
  - `userRole`
  - `isLoading`
  - `isEmailVerified`
- Client components consume auth via `useAuth()` **only**.  
  No other place should fetch auth state directly from Supabase in the browser.

**Middleware responsibilities:**

- Gate by **session/role/suspension** only.
- Never create profiles or mutate data.
- Must allow onboarding-safe routes even when `profile` is `null`:
  - Auth pages (login/signup/verification)
  - Onboarding path
  - `/talent/dashboard` and `/client/dashboard` so `ensureProfileExists()` can run.

**Dashboards:**

- Dashboard **server pages** are thin wrappers:
  - They may fetch **page data** (gigs, bookings, etc.).
  - They do **not** own auth/profile logic.
- Dashboard **client components**:
  - Read `user`, `profile`, `userRole`, and `isLoading` from `useAuth()`.
  - Use a **single loading gate** combining auth + data-loading flags.
  - Avoid `window.location.reload()`.
  - Use `router.refresh()` only when strictly necessary (and never in a mount loop).

### Sign-Out Flow (Phase 5 Behavior)

Sign-out must follow this pattern:

1. **Reset auth state** in `AuthProvider`:
   - `user`, `session`, `userRole`, `profile`, `isEmailVerified`, `hasHandledInitialSession`, `isLoading`.
2. Optionally call `/api/auth/signout` (POST) to clear HTTP-only cookies server-side.
3. Call `supabase.auth.signOut()` from the browser client.
4. Call `resetSupabaseBrowserClient()` to avoid stale authenticated instances.
5. Redirect with:
   - `window.location.replace("/login?signedOut=true")` in the browser.
6. No aggressive manual cookie/localStorage purges or timers unless fixing a **specific documented bug**.

**Do not:**

- Change sign-out to use `window.location.reload()`.
- Introduce multiple competing redirect locations.
- Change `SIGNED_OUT` handling without explaining how it interacts with `signOut()`.

If updating `SIGNED_OUT` handling in `onAuthStateChange`:

- Treat **manual sign out** (user clicked â€œSign Outâ€) as handled primarily by `signOut()`.
- Treat `SIGNED_OUT` as a safety net for:
  - Session expiry
  - Admin deletion
  - Cross-tab sync
- Avoid double redirects and loops.

---

## ðŸ›¡ï¸ SECURITY BEST PRACTICES

- Never expose **service keys** in client code.
- Always validate that the current user has permission to access or modify data.
- Supabase queries are parameterized by default â€“ do not use string concatenation to build queries.
- Respect the **least privilege** principle:
  - Use anon/user client whenever possible.
  - Use admin client only from trusted server code.

---

## ðŸš« FORBIDDEN PATTERNS

- Using `any` types for database results or DTOs.
- Making database changes without updating `database_schema_audit.md`.
- Updating `types/database.ts` by hand (must be generated).
- Direct database calls in React components.
- Bypassing or weakening RLS policies.
- Exposing service keys to client/browser.
- Mixing database logic into UI components.
- Using raw SQL instead of the Supabase query builder (except in migrations/admin scripts where appropriate).
- Full-file rewrites of Red Zone files without going through the **Red Zone Editing Protocol**.

---

## ðŸ“ CRITICAL FILES TO REFERENCE

- `TOTL_PROJECT_CONTEXT_PROMPT.md` â€“ Complete project context
- `AGENT_ONBOARDING.md` â€“ Quick start guide for agents
- `database_schema_audit.md` â€“ **Single source of truth** for schema
- `docs/AUTH_DATABASE_TRIGGER_CHECKLIST.md` â€“ Mandatory for auth changes
- `docs/AUTH_STRATEGY.md` â€“ Auth architecture and patterns
- `docs/SIGN_OUT_IMPROVEMENTS.md` â€“ Current sign-out behavior
- `types/database.ts` / `@/types/supabase` â€“ Generated Supabase types
- `supabase/migrations/**` â€“ Schema history
- `lib/supabase-client.ts` â€“ Browser client config
- `lib/supabase-admin-client.ts` â€“ Server admin client
- `middleware.ts` â€“ Route protection logic
- `components/auth/auth-provider.tsx` â€“ Authentication context owner

---

## ðŸ”„ WHEN TO APPLY THESE RULES

These rules apply to:

- All code generation for this project
- Database schema changes or migrations
- New feature development
- Refactors and bug fixes
- API route creation or modification
- Component creation or updates
- Any changes touching auth, dashboards, or schema

---

## ðŸ§¬ DATABASE TYPES & CODEGEN

- `types/database.ts` is **auto-generated** from Supabase. Do not hand-edit.
- After any schema/migration changes, run:

  ```bash
  npx supabase gen types typescript \
    --project-id "$SUPABASE_PROJECT_ID" \
    --schema public > types/database.ts
````

* Prepend or keep an **AUTO-GENERATED** banner comment in `types/database.ts` to discourage manual edits.
* If there is a `types/supabase.ts` wrapper, it should only re-export from `types/database.ts`.

---

## ðŸ§© SUPABASE CLIENT USAGE

* Use a **single typed client** from `lib/supabase-client.ts` for user-level browser access.
* Use `lib/supabase-admin-client.ts` for server-side admin operations (service role).
* Do **not** import `@supabase/supabase-js` directly in pages/components.
* For server components/actions, use the projectâ€™s existing Supabase helpers (e.g., `createSupabaseServer` pattern if present).

---

## ðŸ§® QUERY STYLE

* Default: **explicit column selection**. Avoid `select('*')` in app code.
* Exception: internal admin scripts in `scripts/` may use `*` with care.
* Use `.maybeSingle()` when a row may be missing; use `.single()` only when youâ€™re sure a row must exist and handle errors accordingly.
* For profile fetching, follow the established `fetchProfile` + `ensureAndHydrateProfile` pattern in `AuthProvider`.

---

## ðŸ§± SCHEMA MANAGEMENT

* **Single Source of Truth:** Always update `database_schema_audit.md` **before** changing schema.
* All schema modifications must:

  1. Be documented in `database_schema_audit.md`.
  2. Have a corresponding migration in `supabase/migrations`.
  3. Regenerate `types/database.ts`.
* Never modify the live database schema manually without a migration.
* Keep **audit file, live DB, and generated types** in sync.
* Use scripts/CI to check for drift where available.

---

## ðŸ”’ TYPE SAFETY

* Use generated types from `@/types/supabase` / `types/database.ts` for all DB entities.
* Do not declare parallel interfaces/types for core tables (`profiles`, `gigs`, `applications`, etc.).
* No `any` for DB data:

  * If a result is typed as `any`, fix the query or import the right type.
* When changing an enum in the DB:

  * Update enum in `database_schema_audit.md`.
  * Regenerate types.
  * Update all string/union references in code.

---

## ðŸ—„ï¸ DATABASE ACCESS PATTERN

* All database calls must go through:

  * `lib/supabase-client.ts` for anon/user-level access
  * `lib/supabase-admin-client.ts` for admin/service-level access
* Do not instantiate new Supabase clients ad-hoc.
* RLS is always on for anon/user clients; rely on it.
* Admin client use must be explicit and server-only.

---

## âœ… VERIFICATION & CI

* Always run `scripts/verify-schema-sync.ps1` before commits/PRs.
* Fix:

  * Type mismatches
  * Outdated schema docs
  * `any` usages for DB data
  * Local interface duplication of DB entities
* CI will block PRs if:

  * Schema drift is detected
  * Types are out of sync
  * Forbidden patterns are introduced

---

## ðŸ’» POWERSHELL ENVIRONMENT

* Use PowerShell commands:

  * `Get-ChildItem` instead of `ls`
  * `Get-Content` instead of `cat`
  * `Select-String` instead of `grep`

* All verification and automation scripts should be PowerShell-compatible.

---

## ðŸ“š DOCUMENTATION-FIRST WORKFLOW

**Before starting ANY work:**

1. Check `docs/DOCUMENTATION_INDEX.md` to find relevant docs.
2. Read all relevant docs for the area youâ€™re touching:

   * Auth â†’ `docs/AUTH_STRATEGY.md`, `docs/AUTH_DATABASE_TRIGGER_CHECKLIST.md`, `docs/SIGN_OUT_IMPROVEMENTS.md`
   * Security â†’ `docs/SECURITY_CONFIGURATION.md`
   * Database â†’ `database_schema_audit.md`, `docs/DATABASE_REPORT.md`
   * Admin features â†’ `docs/ADMIN_ACCOUNT_GUIDE.md`
   * Feature implementation â†’ related guides in `docs/`
   * Bug fixes â†’ `docs/TROUBLESHOOTING_GUIDE.md`
3. Verify your approach aligns with documented patterns.

**After work:**

1. Update relevant documentation.
2. Add new docs for significant features.
3. Update `docs/DOCUMENTATION_INDEX.md` with new entries.

**All new docs go in `docs/`, not root.**

Root exceptions:

* `README.md`
* `database_schema_audit.md`
* `MVP_STATUS_NOTION.md`
* `notion_update.md`

---

## ðŸš¨ CRITICAL ERROR PREVENTION â€“ MANDATORY CHECKS

**Before pushing any code to `develop` or `main`:**

### 1. Schema & Types Verification

```bash
npm run schema:verify:comprehensive
npm run types:check
npm run build
```

### 2. Import Path Verification

**Never use:**

* `@/lib/supabase/supabase-admin-client` (WRONG â€“ extra `/supabase/`)
* `@/types/database` (WRONG â€“ should be `/types/supabase`)

**Always use:**

* `@/lib/supabase-admin-client`
* `@/types/supabase`

### 3. Common Errors to Avoid

* **Schema sync error:** `types/database.ts is out of sync with remote schema`
  â†’ `npm run types:regen` for the correct environment.

* **Import path errors:** `Module not found: Can't resolve '@/lib/supabase/supabase-admin-client'`
  â†’ Fix path to `@/lib/supabase-admin-client`.

* **Type errors:** `Property 'role' does not exist on type 'never'`
  â†’ Ensure `Database` type is imported from `@/types/supabase`.

* **Build failures:** any non-passing local build
  â†’ Do not push.

### 4. Branch-Specific Requirements

* `develop` branch: use `npm run types:regen:dev` if needed.
* `main` branch: use `npm run types:regen:prod` if needed.
* Both: must pass `npm run build` before pushing.

### 5. Emergency Fix Commands

```bash
# Schema sync error
npm run types:regen && npm run build

# Import path errors â€“ find and fix manually
grep -r "@/lib/supabase/supabase-admin-client" . --exclude-dir=node_modules

# Build failures â€“ fix locally first
npm run build
```

**Absolute rule:** Never push code that does not build locally.

---

## ðŸ“‹ PRE-PUSH CHECKLIST

Always run this checklist before pushing:

1. âœ… `npm run schema:verify:comprehensive`
2. âœ… `npm run build`
3. âœ… `npm run lint`
4. âœ… Import paths are correct
5. âœ… Branch-specific types are generated
6. âœ… `docs/PRE_PUSH_CHECKLIST.md` reviewed and followed

If ANY step fails, fix it **before** pushing.

---

## ðŸ’» CODE STYLE & STRUCTURE GUIDELINES

### TypeScript Code Style

* Use functional and declarative patterns; avoid classes.
* Prefer modular code over duplication.
* Use descriptive names with auxiliary verbs for booleans (`isLoading`, `hasError`, `canEdit`).
* File structure:

  1. Imports
  2. Types/interfaces
  3. Constants/helpers
  4. Main component/exports
  5. Subcomponents

**TypeScript usage:**

* Use `interface` for object shapes where possible.
* Avoid enums; use `const` objects + union types.
* Use `import type` when importing only types.
* Strict TypeScript mode is assumed and must remain clean.

```ts
interface ButtonProps {
  isLoading?: boolean;
  hasError?: boolean;
  onClick: () => void;
}

const Status = {
  ACTIVE: "active",
  INACTIVE: "inactive",
  PENDING: "pending",
} as const;

type Status = (typeof Status)[keyof typeof Status];
```

### Naming Conventions

* Files/directories: **kebab-case**

  * `talent-signup-form.tsx`
  * `apply-as-talent-button.tsx`
* Components: **PascalCase**
* Variables/functions: **camelCase**

---

### Syntax and Formatting

* Use `function` declarations for components and pure helpers.
* Use arrow functions for callbacks and small utilities.
* Prefer concise conditionals:

```tsx
if (isLoading) return <Spinner />;
if (hasError) return <ErrorMessage />;
```

---

### UI & Styling

* Use **shadcn/ui** and Radix primitives.
* Use TailwindCSS; no styled-components/CSS modules.
* Mobile-first responsive classes.

```tsx
<div className="flex flex-col gap-4 md:flex-row md:gap-8 lg:gap-12">
  <div className="w-full md:w-1/2 lg:w-1/3">...</div>
</div>
```

* For images, use Next.js `Image` or project `SafeImage` with explicit sizes.

---

### Performance & RSC

* Default to **Server Components**.
* Use Client Components only when needed:

  * Browser APIs
  * Event handlers
  * React hooks
  * Client-only libraries

```tsx
// Server Component
export default async function GigsPage() {
  const supabase = await createSupabaseServer();
  const { data } = await supabase.from("gigs").select("*");
  return <GigsList gigs={data} />;
}

// Client Component
"use client";
export function GigsList({ gigs }: { gigs: Gig[] }) {
  // ...
}
```

* Minimize `useEffect` and `useState`.
* Use Suspense and `loading.tsx` for loading states.
* Use `next/dynamic` for heavy components.

---

### URL Search Parameters

* In Server Components: use `searchParams` prop.
* In Client Components: use `useSearchParams()` safely with `useEffect`.
* Use optional chaining and nullish coalescing.

Refer to `docs/USESEARCHPARAMS_SSR_GUIDE.md` for patterns.

---

### Web Vitals

* Optimize LCP with prioritized hero images.
* Prevent CLS with explicit dimensions.
* Minimize JS, use code splitting, and lazy load non-critical UI.

---

### Code Quality & Error Handling

* Wrap async operations in `try/catch`.
* Use project error logging utilities (e.g., `lib/error-logger.ts`).
* Handle Supabase errors gracefully with meaningful messages.

---

### Accessibility

* Use semantic HTML.
* Add ARIA attributes when needed.
* Ensure keyboard navigation works.
* Rely on Radix for accessible primitives.

---

**Final Principle:**
Prioritize **security**, **type safety**, and **auth stability** over stylistic preferences.
Red Zone files must be changed with precision, not rewritten on a whim.

```
```
