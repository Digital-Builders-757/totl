name: "Schema Truth Verification"

on:
  pull_request:
    paths:
      - "supabase/migrations/**"
      - "types/database.ts"
      - "database_schema_audit.md"
  push:
    branches: [ main ]
    paths:
      - "supabase/migrations/**"
      - "types/database.ts"
      - "database_schema_audit.md"

jobs:
  verify-schema:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Login to Supabase (npx)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: npx -y supabase@v2.33.4 login --token "$SUPABASE_ACCESS_TOKEN"

      - name: Generate types from remote schema (npx)
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: npx -y supabase@v2.33.4 gen types typescript --project-id "$SUPABASE_PROJECT_ID" --schema public > types/temp_schema_types.ts

      - name: Compare generated types with committed types
        run: |
          if ! diff -u types/temp_schema_types.ts types/database.ts; then
            echo ""
            echo "âŒ ERROR: types/database.ts is out of sync with remote schema"
            echo ""
            echo "ðŸ”§ To fix this, run locally:"
            echo "   npx supabase@v2.33.4 gen types typescript --linked --schema public > types/database.ts"
            echo ""
            echo "ðŸ“‹ Changes detected:"
            echo "   - Lines starting with '-' are in your local file but not in remote"
            echo "   - Lines starting with '+' are in remote but missing from your local file"
            echo ""
            exit 1;
          fi

      - name: Run schema truth verification script
        shell: pwsh
        run: ./scripts/verify-schema-sync.ps1 -SkipDbGeneration

      - name: Cleanup temp files
        if: always()
        run: rm -f types/temp_schema_types.ts 